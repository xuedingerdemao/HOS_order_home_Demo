import { LoginApI, ResManager, TokenStore } from '@orderHome/common/basic';
import { authentication } from '@kit.AccountKit';
import { util } from '@kit.ArkTS';
import { Log } from '@abner/log';
import { promptAction, router } from '@kit.ArkUI';

@Entry
@Component
struct LoginPage {
  tokenStore: TokenStore = new TokenStore(getContext())

  /*-----------------------ðŸ‘‡ðŸ‘‡ function ðŸ‘‡ðŸ‘‡--------------------------------*/
  // ç™»å½•æ–¹æ³•
  login() {
    // åˆ›å»ºæŽˆæƒè¯·æ±‚ï¼Œå¹¶è®¾ç½®å‚æ•°
    let authRequest = new authentication.HuaweiIDProvider().createAuthorizationWithHuaweiIDRequest();
    // èŽ·å–æ‰‹æœºå·éœ€è¦ä¼ å¦‚ä¸‹scopeï¼Œä¼ å‚æ•°ä¹‹å‰éœ€è¦å…ˆç”³è¯·å¯¹åº”scopeæƒé™,æ‰èƒ½è¿”å›žå¯¹åº”æ•°æ®
    authRequest.scopes = ['phone'];
    // èŽ·å–codeéœ€ä¼ å¦‚ä¸‹permission
    authRequest.permissions = ['serviceauthcode'];
    // ç”¨æˆ·æ˜¯å¦éœ€è¦ç™»å½•æŽˆæƒï¼Œè¯¥å€¼ä¸ºtrueä¸”ç”¨æˆ·æœªç™»å½•æˆ–æœªæŽˆæƒæ—¶ï¼Œä¼šæ‹‰èµ·ç”¨æˆ·ç™»å½•æˆ–æŽˆæƒé¡µé¢
    authRequest.forceAuthorization = true;
    // ç”¨äºŽé˜²è·¨ç«™ç‚¹è¯·æ±‚ä¼ªé€ ï¼Œéžç©ºå­—ç¬¦ä¸²å³å¯
    authRequest.state = util.generateRandomUUID();
    // æ‰§è¡Œè¯·æ±‚
    try {
      let controller = new authentication.AuthenticationController(getContext(this));
      controller.executeRequest(authRequest, async (err, data) => {
        if (err) {
          Log.error('auth fail,error: %{public}s' + JSON.stringify(err));
          return;
        }
        let authorizationWithHuaweiIDResponse = data as authentication.AuthorizationWithHuaweiIDResponse;
        let state = authorizationWithHuaweiIDResponse.state;
        if (state != undefined && authRequest.state != state) {
          Log.error('auth fail,The state is different: %{public}s' +
          JSON.stringify(authorizationWithHuaweiIDResponse));
          return;
        }
        Log.debug('auth success: %{public}s' +
        JSON.stringify(authorizationWithHuaweiIDResponse));
        let authorizationWithHuaweiIDCredential = authorizationWithHuaweiIDResponse.data!;
        let code = authorizationWithHuaweiIDCredential.authorizationCode;
        // å¼€å‘è€…å¤„ç†code=> èŽ·å–ä¸€é”®ç™»å½•çš„æŽˆæƒ code=>è°ƒç”¨åŽå° api =ã€‹èŽ·å– token
        Log.warn(`åŽä¸ºæŽˆæƒç ï¼š${code}`)
        promptAction.showDialog({ message: `åŽä¸ºæŽˆæƒç ï¼š${code}` })
        const token = await LoginApI({
          code: code!,
          clientId: '111293791',
          clientSecret: 'f41254cd94d3a104f53c744aa46a3b80ff37307968348e7fa94325bb40a6e043'
        })
        Log.info('tokenðŸ‘¼' + token)
        // æŒä¹…åŒ–
        await this.tokenStore.setToken(token)
        router.replaceUrl({
          url: 'pages/Index'
        })
      });
    } catch (error) {
      Log.error('auth failed: %{public}s' + JSON.stringify(error));
    }
  }

  build() {
    Stack({ alignContent: Alignment.Center }) {
      Column() {
        // app ä¿¡æ¯
        Column() {
          Text() {
            Span('æ ‡é¢˜å•Šæ ‡é¢˜å•Š')
              .fontColor('#000')
              .fontSize(24)
              .fontWeight(700)
          }

          Text() {
            Span('ç™»å½•é¡µ')
              .fontColor('#000')
              .fontSize(24)
              .fontWeight(700)
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#fff')

        Button({ stateEffect: true }) {
          Row({ space: 6.5 }) {
            Image(ResManager.IC_HUAWEI)
              .width(24)
              .aspectRatio(1)
            Text('åŽä¸ºç™»å½•')
              .fontColor('#fff')
              .fontWeight(500)
              .fontSize(ResManager.EC_MODULE_TITLE_FS)
          }
        }
        .margin({ top: 150 })
        .width(250)
        .height(40)
        .backgroundColor(ResManager.EC_MAIN_COLOR)
        .onClick(() => {
          this.login()
        })

      }
    }
    .width('100%')
    .height('100%')
  }
}